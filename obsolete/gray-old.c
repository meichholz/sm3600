/* ======================================================================

Userspace scan tool for the Microtek 3600 scanner

grayscale scan routine

(C) Marian Eichholz 2001

====================================================================== */

#include "scantool.h"

/* **********************************************************************

DoScanGray()

********************************************************************** */

#define LINE_THRESHOLD   0x80

static unsigned char uchRegs075[]={
   /*R_SPOS*/ 0xFC, /*R_SPOSH*/ 0x00, /*0x03*/ 0x20,
   /*R_SWID*/ 0xB0, /*R_SWIDH*/ 0x04, /*R_STPS*/ 0x06,
   /*R_STPSH*/ 0x00, /*0x08*/ 0x00, /*0x09*/ 0x3F,
   /*R_LEN*/ 0x28, /*R_LENH*/ 0x07, /*0x0C*/ 0x6D,
   /*0x0D*/ 0x70, /*0x0E*/ 0x69, /*0x0F*/ 0xD0,
   /*0x10*/ 0x00, /*0x11*/ 0x00, /*0x12*/ 0x40,
   /*0x13*/ 0x15, /*0x14*/ 0x80, /*0x15*/ 0x2A,
   /*0x16*/ 0xC0, /*0x17*/ 0x40, /*0x18*/ 0xC0,
   /*0x19*/ 0x40, /*0x1A*/ 0xFF, /*0x1B*/ 0x01,
   /*0x1C*/ 0x88, /*0x1D*/ 0x40, /*0x1E*/ 0x4C,
   /*0x1F*/ 0x50, /*0x20*/ 0x00, /*0x21*/ 0x0C,
   /*0x22*/ 0x21, /*0x23*/ 0xF0, /*0x24*/ 0x40,
   /*0x25*/ 0x00, /*0x26*/ 0x0A, /*0x27*/ 0xF0,
   /*0x28*/ 0x00, /*0x29*/ 0x00, /*0x2A*/ 0x4E,
   /*0x2B*/ 0xF0, /*0x2C*/ 0x00, /*0x2D*/ 0x00,
   /*0x2E*/ 0x4E, /*R_CCAL*/ 0x80, /*R_CCAL2*/ 0x80,
   /*R_CCAL3*/ 0x80, /*0x32*/ 0xC9, /*0x33*/ 0x20,
   /*0x34*/ 0x83, /*0x35*/ 0x29, /*0x36*/ 0x00,
   /*0x37*/ 0x00, /*0x38*/ 0x00, /*0x39*/ 0x00,
   /*0x3A*/ 0x00, /*0x3B*/ 0x00, /*0x3C*/ 0xFF,
   /*0x3D*/ 0x0F, /*0x3E*/ 0x00, /*0x3F*/ 0x00,
   /*0x40*/ 0x01, /*0x41*/ 0x00, /*R_CSTAT*/ 0x00,
   /*0x43*/ 0x03, /*R_LMP*/ 0x01, /*0x45*/ 0x00,
   /*R_CTL*/ 0x39, /*0x47*/ 0xC0, /*0x48*/ 0x40,
   /*0x49*/ 0x9E, /*0x4A*/ 0x8C };

static unsigned char uchRegs100[]={
   /*R_SPOS*/ 0xFC, /*R_SPOSH*/ 0x00, /*0x03*/ 0x20,
   /*R_SWID*/ 0xB0, /*R_SWIDH*/ 0x04, /*R_STPS*/ 0x06,
   /*R_STPSH*/ 0x00, /*0x08*/ 0x00, /*0x09*/ 0x3F,
   /*R_LEN*/ 0x34, /*R_LENH*/ 0x07, /*0x0C*/ 0x6D,
   /*0x0D*/ 0x70, /*0x0E*/ 0x69, /*0x0F*/ 0xD0,
   /*0x10*/ 0x00, /*0x11*/ 0x00, /*0x12*/ 0x42,
   /*0x13*/ 0x15, /*0x14*/ 0x84, /*0x15*/ 0x2A,
   /*0x16*/ 0xC2, /*0x17*/ 0x40, /*0x18*/ 0xC2,
   /*0x19*/ 0x40, /*0x1A*/ 0xFF, /*0x1B*/ 0x01,
   /*0x1C*/ 0x88, /*0x1D*/ 0x40, /*0x1E*/ 0x4C,
   /*0x1F*/ 0x50, /*0x20*/ 0x00, /*0x21*/ 0x0C,
   /*0x22*/ 0x21, /*0x23*/ 0xF0, /*0x24*/ 0x40,
   /*0x25*/ 0x00, /*0x26*/ 0x0A, /*0x27*/ 0xF0,
   /*0x28*/ 0x00, /*0x29*/ 0x00, /*0x2A*/ 0x4E,
   /*0x2B*/ 0xF0, /*0x2C*/ 0x00, /*0x2D*/ 0x00,
   /*0x2E*/ 0x4E, /*R_CCAL*/ 0x80, /*R_CCAL2*/ 0x80,
   /*R_CCAL3*/ 0x80, /*0x32*/ 0xC9, /*0x33*/ 0x20,
   /*0x34*/ 0x63, /*0x35*/ 0x29, /*0x36*/ 0x00,
   /*0x37*/ 0x00, /*0x38*/ 0x00, /*0x39*/ 0x00,
   /*0x3A*/ 0x00, /*0x3B*/ 0x00, /*0x3C*/ 0xFF,
   /*0x3D*/ 0x0F, /*0x3E*/ 0x00, /*0x3F*/ 0x00,
   /*0x40*/ 0x01, /*0x41*/ 0x00, /*R_CSTAT*/ 0x80,
   /*0x43*/ 0x03, /*R_LMP*/ 0x01, /*0x45*/ 0x00,
   /*R_CTL*/ 0x39, /*0x47*/ 0xC2, /*0x48*/ 0x40,
   /*0x49*/ 0x9E, /*0x4A*/ 0x8C };

static unsigned char uchRegs200[]={
   /*R_SPOS*/ 0xFC, /*R_SPOSH*/ 0x00, /*0x03*/ 0x24,
   /*R_SWID*/ 0xB0, /*R_SWIDH*/ 0x04, /*R_STPS*/ 0x06,
   /*R_STPSH*/ 0x00, /*0x08*/ 0x00, /*0x09*/ 0x3F,
   /*R_LEN*/ 0x22, /*R_LENH*/ 0x07, /*0x0C*/ 0x6D,
   /*0x0D*/ 0x70, /*0x0E*/ 0x69, /*0x0F*/ 0xD0,
   /*0x10*/ 0x00, /*0x11*/ 0x00, /*0x12*/ 0x42,
   /*0x13*/ 0x15, /*0x14*/ 0x42, /*0x15*/ 0x15,
   /*0x16*/ 0x42, /*0x17*/ 0x15, /*0x18*/ 0x42,
   /*0x19*/ 0x15, /*0x1A*/ 0x07, /*0x1B*/ 0x00,
   /*0x1C*/ 0x08, /*0x1D*/ 0x12, /*0x1E*/ 0x4C,
   /*0x1F*/ 0x50, /*0x20*/ 0x00, /*0x21*/ 0x0C,
   /*0x22*/ 0x21, /*0x23*/ 0xF0, /*0x24*/ 0x40,
   /*0x25*/ 0x00, /*0x26*/ 0x0A, /*0x27*/ 0xF0,
   /*0x28*/ 0x00, /*0x29*/ 0x00, /*0x2A*/ 0x4E,
   /*0x2B*/ 0xF0, /*0x2C*/ 0x00, /*0x2D*/ 0x00,
   /*0x2E*/ 0x4E, /*R_CCAL*/ 0x80, /*R_CCAL2*/ 0x80,
   /*R_CCAL3*/ 0x80, /*0x32*/ 0xC9, /*0x33*/ 0x20,
   /*0x34*/ 0x43, /*0x35*/ 0x29, /*0x36*/ 0x00,
   /*0x37*/ 0x00, /*0x38*/ 0x00, /*0x39*/ 0x00,
   /*0x3A*/ 0x00, /*0x3B*/ 0x00, /*0x3C*/ 0xFF,
   /*0x3D*/ 0x0F, /*0x3E*/ 0x00, /*0x3F*/ 0x00,
   /*0x40*/ 0x01, /*0x41*/ 0x00, /*R_CSTAT*/ 0x80,
   /*0x43*/ 0x03, /*R_LMP*/ 0x01, /*0x45*/ 0x00,
   /*R_CTL*/ 0x39, /*0x47*/ 0x42, /*0x48*/ 0x15,
   /*0x49*/ 0x9E, /*0x4A*/ 0x8C };

static unsigned char uchRegs300[]={
   /*R_SPOS*/ 0xFC, /*R_SPOSH*/ 0x00, /*0x03*/ 0x2A,
   /*R_SWID*/ 0xB0, /*R_SWIDH*/ 0x04, /*R_STPS*/ 0x06,
   /*R_STPSH*/ 0x00, /*0x08*/ 0x00, /*0x09*/ 0x2A,
   /*R_LEN*/ 0x16, /*R_LENH*/ 0x07, /*0x0C*/ 0x6D,
   /*0x0D*/ 0x70, /*0x0E*/ 0x69, /*0x0F*/ 0xD0,
   /*0x10*/ 0x00, /*0x11*/ 0x00, /*0x12*/ 0x40,
   /*0x13*/ 0x15, /*0x14*/ 0x40, /*0x15*/ 0x15,
   /*0x16*/ 0x40, /*0x17*/ 0x15, /*0x18*/ 0x40,
   /*0x19*/ 0x15, /*0x1A*/ 0x07, /*0x1B*/ 0x00,
   /*0x1C*/ 0x08, /*0x1D*/ 0x12, /*0x1E*/ 0x4C,
   /*0x1F*/ 0x50, /*0x20*/ 0x00, /*0x21*/ 0x0C,
   /*0x22*/ 0x21, /*0x23*/ 0xF0, /*0x24*/ 0x40,
   /*0x25*/ 0x00, /*0x26*/ 0x0A, /*0x27*/ 0xF0,
   /*0x28*/ 0x00, /*0x29*/ 0x00, /*0x2A*/ 0x4E,
   /*0x2B*/ 0xF0, /*0x2C*/ 0x00, /*0x2D*/ 0x00,
   /*0x2E*/ 0x4E, /*R_CCAL*/ 0x80, /*R_CCAL2*/ 0x80,
   /*R_CCAL3*/ 0x80, /*0x32*/ 0xC9, /*0x33*/ 0x20,
   /*0x34*/ 0x03, /*0x35*/ 0x29, /*0x36*/ 0x00,
   /*0x37*/ 0x00, /*0x38*/ 0x00, /*0x39*/ 0x00,
   /*0x3A*/ 0x00, /*0x3B*/ 0x00, /*0x3C*/ 0xFF,
   /*0x3D*/ 0x0F, /*0x3E*/ 0x00, /*0x3F*/ 0x00,
   /*0x40*/ 0x01, /*0x41*/ 0x00, /*R_CSTAT*/ 0x80,
   /*0x43*/ 0x03, /*R_LMP*/ 0x01, /*0x45*/ 0x00,
   /*R_CTL*/ 0x39, /*0x47*/ 0x40, /*0x48*/ 0x15,
   /*0x49*/ 0x96, /*0x4A*/ 0x8C };

static unsigned char uchRegs600[]={
   /*R_SPOS*/ 0xFC, /*R_SPOSH*/ 0x00, /*0x03*/ 0x3F,
   /*R_SWID*/ 0xB0, /*R_SWIDH*/ 0x04, /*R_STPS*/ 0x06,
   /*R_STPSH*/ 0x00, /*0x08*/ 0x00, /*0x09*/ 0x3F,
   /*R_LEN*/ 0x16, /*R_LENH*/ 0x07, /*0x0C*/ 0x6D,
   /*0x0D*/ 0x70, /*0x0E*/ 0x69, /*0x0F*/ 0xD0,
   /*0x10*/ 0x00, /*0x11*/ 0x00, /*0x12*/ 0x42,
   /*0x13*/ 0x15, /*0x14*/ 0x42, /*0x15*/ 0x15,
   /*0x16*/ 0x42, /*0x17*/ 0x15, /*0x18*/ 0x42,
   /*0x19*/ 0x15, /*0x1A*/ 0x07, /*0x1B*/ 0x00,
   /*0x1C*/ 0x08, /*0x1D*/ 0x12, /*0x1E*/ 0x4C,
   /*0x1F*/ 0x50, /*0x20*/ 0x00, /*0x21*/ 0x0C,
   /*0x22*/ 0x21, /*0x23*/ 0xF0, /*0x24*/ 0x40,
   /*0x25*/ 0x00, /*0x26*/ 0x0A, /*0x27*/ 0xF0,
   /*0x28*/ 0x00, /*0x29*/ 0x00, /*0x2A*/ 0x4E,
   /*0x2B*/ 0xF0, /*0x2C*/ 0x00, /*0x2D*/ 0x00,
   /*0x2E*/ 0x4E, /*R_CCAL*/ 0x80, /*R_CCAL2*/ 0x80,
   /*R_CCAL3*/ 0x80, /*0x32*/ 0xC9, /*0x33*/ 0x20,
   /*0x34*/ 0x03, /*0x35*/ 0x29, /*0x36*/ 0x00,
   /*0x37*/ 0x00, /*0x38*/ 0x00, /*0x39*/ 0x00,
   /*0x3A*/ 0x00, /*0x3B*/ 0x00, /*0x3C*/ 0xFF,
   /*0x3D*/ 0x0F, /*0x3E*/ 0x00, /*0x3F*/ 0x00,
   /*0x40*/ 0x01, /*0x41*/ 0x00, /*R_CSTAT*/ 0x80,
   /*0x43*/ 0x03, /*R_LMP*/ 0x01, /*0x45*/ 0x00,
   /*R_CTL*/ 0x39, /*0x47*/ 0x42, /*0x48*/ 0x15,
   /*0x49*/ 0x96, /*0x4A*/ 0x8C };


/*
I admit, the scanning routine is somewhat bloated now, for it has some
retention buffering for error diffusion, and it is not optimised for
CPU usage.

There is some space for optimisation and possibly a code split, if we
really know, what we are doing. (eichholz, 12.4.2001).
*/

int DoScanGray(TInstance *this)
{
  int    cxPixel,cyPixel; /* real pixel */
  int    cxWindow,cxMax; /* in real pixels */
  int    cyTotalPath;    /* from bed start to window end in 600 dpi */
  int    nFixAspect;     /* aspect ratio in percent, 75-100 */
  unsigned char  *puchRegs;
  unsigned char  *pchBuf;    /* bulk transfer buffer */
  short         **ppchLines; /* for halftone error diffusion */
  int             i;
  puchRegs=NULL;
  cxPixel=this->param.cx*this->param.res/1200;
  cyPixel=this->param.cy*this->param.res/1200;
  if (bVerbose)
    fprintf(stderr,"scanning %d by %d in gray\n",cxPixel,cyPixel);
  nFixAspect=100;
  switch (this->param.res)
  {
  case 75:  nFixAspect=75;
            puchRegs=uchRegs075; break;
  case 100: puchRegs=uchRegs100; break;
  case 200: puchRegs=uchRegs200; break;
  case 300: puchRegs=uchRegs300; break;
  case 600: puchRegs=uchRegs600; break;
  }
  cyTotalPath = this->param.y/2;
  DoJog(this,cyTotalPath);
  INST_ASSERT();
  cyTotalPath += this->param.cy/2; /* for jogging back */
  
  /*
    regular scan is asynchronously, that is,
    the scanning is issued, and the driver does bulk reads,
    until there are no data left.
  */
  RegWriteArray(this,R_ALL, NUM_SCANREGS, puchRegs); INST_ASSERT();
  RegWrite(this,R_SPOS, 2, this->param.x/2+this->calibration.xMargin); INST_ASSERT();
  RegWrite(this,R_SLEN, 2, (cyPixel+1)*600/this->param.res); INST_ASSERT();
  if (this->quality==fast) { }

  /* cxPixel is the number os pixels, we *want* (after interpolation)
     cxMax is the number of pixels, we *need* (before interpolation)
     cxWindow is the scan width in 600 dpi, we have to request */

  cxMax=cxPixel*100/nFixAspect;
  cxWindow=this->param.cx/2;
  RegWrite(this,R_SWID, 2, cxWindow); INST_ASSERT();

  /* for halftone dithering we need one history line */
  pchBuf=malloc(0x8000);
  ppchLines=calloc(2,sizeof(short *));
  if (!pchBuf || !ppchLines)
    return SetError(this,PANIC_RUNTIME,"no buffers available");
  for (i=0; i<2; i++)
    {
      ppchLines[i]=calloc(cxMax+1,sizeof(short)); /* 1 dummy at right edge */
      if (!ppchLines[i])
	return SetError(this,PANIC_RUNTIME,"no buffers available");
    }

  /* start the unit, when all buffers are available */

  RegWrite(this,R_CTL, 1, 0x39); INST_ASSERT();
  RegWrite(this,R_CTL, 1, 0x79); INST_ASSERT();
  RegWrite(this,R_CTL, 1, 0xF9); INST_ASSERT();

  if (this->fhScan && !this->bWriteRaw)
    {
      if (this->mode==gray)
 	fprintf(this->fhScan,"P5\n%d %d\n255\n",cxPixel,cyPixel);
      else
	fprintf(this->fhScan,"P4\n%d %d\n",cxPixel,cyPixel);
    }

  /* the line rebuffering code is a stripped down version of the color
     processing algorithm.*/

  /* The line buffer is of "short" type, becaus we use error diffusion.
     The buffer is not directly written, but the pixel values are added,
     to preserve the diffused error values of the last line.
     All values are in 10 percent, thus beeing fixes decimal. */
  {
    int iFrom,iTo,iChunk,cchBulk,iLine;
    int iDot;
    unsigned char chBits;  
    iChunk=0;
    cchBulk=0;
    iTo=0;
    iFrom=cchBulk; /* no rest */
    iLine=0;
    do {
      iChunk++;
      if (!this->bWriteRaw)
	{
	  iTo=0;
	  while (iFrom<cchBulk)
	    ppchLines[0][iTo++] += 10*pchBuf[iFrom++];
	}
      
      cchBulk=BulkReadBuffer(this,pchBuf,0x8000); INST_ASSERT();
      FixExposure(pchBuf,cchBulk,
		  this->param.nBrightness,
		  this->param.nContrast);
      dprintf(DEBUG_SCAN,"bulk#%d, got %d bytes...\n",iChunk,cchBulk);

      if (this->bWriteRaw)
	fwrite(pchBuf,1,cchBulk,this->fhScan);
      else
	{
	  iFrom=0;
	  while (iFrom+cxMax<=cchBulk) /* while line in buffer */
	    {
	      int cxToWrite,nInterpolator;
	      cxToWrite=cxPixel;
	      nInterpolator=100;
	      /* dprintf(DEBUG_SCAN,"cx=%d, cxMax=%d\n",cxToWrite,cxMax); */
	      /* iTo starts with buffer offset from copy above */
	      while (iTo<cxMax) /* whole line or rest */
		ppchLines[0][iTo++] += 10*pchBuf[iFrom++];
	      iLine++;
	      iDot=0; chBits=0; /* init pixelbuffer */
	      for (iTo=0; iTo<cxMax && cxToWrite>0; iTo++)
		{
		  nInterpolator+=nFixAspect;
		  if (nInterpolator<100) continue; /* res. reduction */
		  nInterpolator-=100;
		  cxToWrite--;
		  /* dprintf(DEBUG_SCAN," i=%d",iTo); */
		  if (this->mode==gray)
		    {
		      char ch=ppchLines[0][iTo]/10;
		      fwrite(&ch,1,1,this->fhScan);
		    }
		  else
		    {
		      unsigned char chBit; /* 1=white */
		      if (this->mode==line)
			chBit=(ppchLines[0][iTo]<LINE_THRESHOLD);
		      else
		        {
			  short nError=ppchLines[0][iTo];
			  /* printf("(%d)",nError); */
			  if (nError>=2550)
			    {
			      nError-=2550;
			      chBit=0;
			    }
			  else
			    chBit=1;
			  /* since I sketched the Floydd-Steinberg
			     algorithm from heart, I have no idea, if
			     there is room for improvement in the
			     coefficients.  If You know, please drop
			     me a line (eichholz, 1.4.2001) */
			  ppchLines[0][iTo+1]+=nError*3/10;
			  ppchLines[1][iTo+1]+=nError*3/10;
			  ppchLines[1][iTo]  +=nError*4/10;
			}
		      chBits=(chBits<<1)|chBit;
		      iDot++;
		      if (iDot==8)
			{
			  fwrite(&chBits,1,1,this->fhScan);
			  iDot=0; chBits=0;
			}
		    } /* gray pixel postprocessing */
		} /* line postprocessing */
	      if (iDot)
		fwrite(&chBits,1,1,this->fhScan);
	      /* swap the history lines and clear the preread buffer*/
	      {
		short *p=ppchLines[0];
		ppchLines[0]=ppchLines[1];
		ppchLines[1]=p;
	      }
	      memset(ppchLines[1],0,(cxMax+1)*sizeof(short));
	      iTo=0; /* reset buffer offset */
	    } /* while pixels available */
	} /* ! bWriteRaw */
      
    } while (cchBulk==0x8000);
  } /* buffer processing */
  free(ppchLines[1]);
  free(ppchLines[0]);
  free(ppchLines);
  free(pchBuf);
  /* move slider back to start */
  INST_ASSERT();
  return DoJog(this,-cyTotalPath);
}

