/* ======================================================================

Userspace scan tool for the Microtek 3600 scanner

$Id: scanmtek.c,v 1.9 2001/04/07 23:16:43 eichholz Exp $

====================================================================== */

#include "scantool.h"

/* **********************************************************************

DoInit()

Replay the first initialisation block (no slider movement).

********************************************************************** */

int DoInit(TInstance *this)
{
  unsigned char uchRegs2466[]={
      0x00 /*0x01*/, 0x00 /*0x02*/, 0x3F /*0x03*/,
      0x10 /*0x04*/, 0xC0 /*0x05*/, 0x00 /*0x06*/,
      0x00 /*0x07*/, 0xFF /*0x08*/, 0xFF /*0x09*/,
      0x20 /*0x0A*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x80 /*R_CCAL*/, 0x80 /*R_CCAL2*/,
      0x80 /*R_CCAL3*/, 0x29 /* */, 0x35 /* */,
      0x63 /*0x34*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x00 /*R_CSTAT*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x39 /*R_CTL*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x96 /*0x49*/, 0xD8 /*0x4A*/ };
  dprintf(DEBUG_SCAN,"general init...\n");
  return RegWriteArray(this, R_ALL, 74, uchRegs2466);
}

/* **********************************************************************

WaitWhileBusy()

NOTE: Semantics changed: 0 on success, -1 else

********************************************************************** */

int WaitWhileBusy(TInstance *this, int cSecs)
{
  int cTimeOut=cSecs*10;
  int value;
  INST_ASSERT();
  while (cTimeOut--)
    {
      if ((value=(int)RegRead(this,R_CTL,1)) & 0x80)
	usleep(50);
      else
	return 0;
    }
  return SetError(this,PANIC_COMM,"Timeout while waiting for CTL");
}

/* **********************************************************************

WaitWhileScanning()

NOTE: Semantics changed: 0 on success, -1 else

********************************************************************** */

int WaitWhileScanning(TInstance *this, int cSecs)
{
  int cTimeOut=cSecs*10;
  int value;
  INST_ASSERT();
  while (cTimeOut--)
    {
      if ((value=(int)RegRead(this,R_CSTAT, 1)) & 0x80)
	return 0;
      else
	usleep(50);
    }
  return SetError(this,PANIC_COMM,"Timeout while waiting for CSTAT");
}

/* **********************************************************************

DoLampSwitch(nRegister)

0x01 should switch the lamp ON
0x02 should swuitch it OFF

********************************************************************** */

int DoLampSwitch(TInstance *this, int nPattern)
{
  return RegWrite(this, R_LMP, 1, nPattern);
}

/* **********************************************************************

DoCalibration

********************************************************************** */

int DoCalibration(TInstance *this)
{
  int cchBulk;
  INST_ASSERT();
  dprintf(DEBUG_SCAN,"do calibration...\n");

  /* this sequence makes a jump start (0.5 cm) forward and stops.
     Maybe it is the "start scan" position. */

  dprintf(DEBUG_SCAN,"start scan position...\n");
  
  RegWrite(this,0x34, 1, 0x63);
  RegWrite(this,0x49, 1, 0x96);
  WaitWhileBusy(this,2);
  RegWrite(this,0x34, 1, 0x63);
  RegWrite(this,0x49, 1, 0x9E); /* that is a difference! */
  INST_ASSERT();
  {
    unsigned char uchRegs2587[]={
      0x00 /*0x01*/, 0x00 /*0x02*/, 0x3F /*0x03*/,
      0x40 /*!!0x04!!*/, 0x00 /*!!0x05!!*/, 0xC8 /*!!0x06!!*/,
      0x00 /*0x07*/, 0x00 /*0x08*/, 0x00 /*!!0x09!!*/,
      0x00 /*!!0x0A!!*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x88 /*R_CCAL*/, 0x88 /*R_CCAL2*/,
      0x84 /*R_CCAL3*/, 0xEA /*R_LEN*/, 0x24 /*R_LENH*/,
      0x63 /*0x34*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x80 /*R_CSTAT*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x79 /*!!R_CTL!!*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x9E /*!!0x49!!*/, 0xD8 /*0x4A*/ };
    RegWriteArray(this, R_ALL, 74, uchRegs2587);
  }    /* #2587[065.4] */
  INST_ASSERT();
  RegWrite(this,R_CTL, 1, 0x39);    /* #2588[065.4] */
  RegWrite(this,R_CTL, 1, 0x79);    /* #2589[065.4] */
  RegWrite(this,R_CTL, 1, 0xF9);    /* #2590[065.4] */
  WaitWhileBusy(this, 5);
  INST_ASSERT();

  dprintf(DEBUG_SCAN,"magic1...\n");
  {
    unsigned char uchRegs2609[]={
      0x00 /*0x01*/, 0x00 /*0x02*/, 0x3F /*0x03*/,
      0x10 /*!!0x04!!*/, 0xC0 /*!!0x05!!*/, 0x00 /*!!0x06!!*/,
      0x00 /*0x07*/, 0xFF /*!!0x08!!*/, 0xFF /*!!0x09!!*/,
      0x20 /*!!0x0A!!*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x80 /*!!R_CCAL!!*/, 0x80 /*!!R_CCAL2!!*/,
      0x80 /*!!R_CCAL3!!*/, 0x29 /*!!R_LEN!!*/, 0x35 /*!!R_LENH!!*/,
      0x63 /*0x34*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x00 /*!!R_CSTAT!!*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x39 /*!!R_CTL!!*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x96 /*!!0x49!!*/, 0xD8 /*0x4A*/ };
    RegWriteArray(this, R_ALL, 74, uchRegs2609);
  }    /* #2609[066.2] */
  INST_ASSERT();
  RegWrite(this,R_CTL, 1, 0x39);    /* #2614[066.2] */
  WaitWhileBusy(this,3);
  INST_ASSERT();

  dprintf(DEBUG_SCAN,"magic2...\n");
  {
    unsigned char uchRegs2617[]={
      0x73 /*!!0x01!!*/, 0x03 /*!!0x02!!*/, 0x20 /*!!0x03!!*/,
      0x00 /*!!0x04!!*/, 0xCF /*!!0x05!!*/, 0x00 /*0x06*/,
      0x00 /*0x07*/, 0xFF /*0x08*/, 0xFF /*0x09*/,
      0x02 /*!!0x0A!!*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x80 /*R_CCAL*/, 0x80 /*R_CCAL2*/,
      0x80 /*R_CCAL3*/, 0xEA /*!!R_LEN!!*/, 0x24 /*!!R_LENH!!*/,
      0x63 /*0x34*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x00 /*R_CSTAT*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x39 /*R_CTL*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x96 /*0x49*/, 0xD8 /*0x4A*/ };
    RegWriteArray(this, R_ALL, 74, uchRegs2617);
  }    /* #2617[066.2] */
  INST_ASSERT();
  RegWrite(this,0x34, 1, 0x03);    /* #2618[066.2] */
  RegWrite(this,0x49, 1, 0x96);    /* #2619[066.2] */
  RegWrite(this,R_CTL, 1, 0x79);    /* #2620[066.2] */
  RegWrite(this,R_CTL, 1, 0xF9);    /* #2621[066.2] */
  INST_ASSERT();
  WaitWhileScanning(this, 3);
  INST_ASSERT();
  cchBulk=2*RegRead(this,R_STAT,2); /* the mysterious 3840 bytes */
  INST_ASSERT();
  dprintf(DEBUG_SCAN,"reading %d bytes...\n",cchBulk);
  BulkRead(this,NULL,cchBulk);
  INST_ASSERT();
  WaitWhileBusy(this, 3);

  dprintf(DEBUG_SCAN,"magic2...\n");
  {
    unsigned char uchRegs2631[]={
      0x73 /*0x01*/, 0x03 /*0x02*/, 0x20 /*0x03*/,
      0x00 /*0x04*/, 0xCF /*0x05*/, 0x00 /*0x06*/,
      0x00 /*0x07*/, 0xFF /*0x08*/, 0xFF /*0x09*/,
      0x02 /*0x0A*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x80 /*R_CCAL*/, 0x80 /*R_CCAL2*/,
      0x80 /*R_CCAL3*/, 0x0B /*!!R_LEN!!*/, 0x29 /*!!R_LENH!!*/,
      0x03 /*!!0x34!!*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x80 /*!!R_CSTAT!!*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x79 /*!!R_CTL!!*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x96 /*0x49*/, 0xD8 /*0x4A*/ };
    RegWriteArray(this, R_ALL, 74, uchRegs2631);
  }    /* #2631[066.4] */
  INST_ASSERT();
  RegWrite(this,0x34, 1, 0x03);    /* #2632[066.4] */
  RegWrite(this,0x49, 1, 0x96);    /* #2633[066.4] */
  RegWrite(this,R_CTL, 1, 0x79);    /* #2634[066.5] */
  RegWrite(this,R_CTL, 1, 0xF9);    /* #2635[066.5] */
  WaitWhileScanning(this, 3);
  INST_ASSERT();
  cchBulk=2*RegRead(this,R_STAT, 2);
  INST_ASSERT();
  dprintf(DEBUG_SCAN,"reading %d bytes...\n",cchBulk);
  BulkRead(this,NULL,cchBulk); /* again, why 3840 ? */
  WaitWhileBusy(this,3);
  INST_ASSERT();

  dprintf(DEBUG_SCAN,"magic3...\n");
  WaitWhileBusy(this,3);
  RegWrite(this,R_CTL, 1, 0x39);    /* #2648[066.7] */
  RegWrite(this,R_CCAL, 3, 0x848888);    /* #2650[066.7] */
  {
    unsigned char uchRegs2651[]={
      0x19 /*!!0x01!!*/, 0x00 /*!!0x02!!*/, 0x3F /*!!0x03!!*/,
      0x18 /*!!0x04!!*/, 0xC0 /*!!0x05!!*/, 0x00 /*0x06*/,
      0x00 /*0x07*/, 0xFF /*0x08*/, 0xFF /*0x09*/,
      0x02 /*0x0A*/, 0x00 /*0x0B*/, 0x6D /*0x0C*/,
      0x70 /*0x0D*/, 0x69 /*0x0E*/, 0xD0 /*0x0F*/,
      0x00 /*0x10*/, 0x00 /*0x11*/, 0x40 /*0x12*/,
      0x15 /*0x13*/, 0x80 /*0x14*/, 0x2A /*0x15*/,
      0xC0 /*0x16*/, 0x40 /*0x17*/, 0xC0 /*0x18*/,
      0x40 /*0x19*/, 0xFF /*0x1A*/, 0x01 /*0x1B*/,
      0x88 /*0x1C*/, 0x40 /*0x1D*/, 0x4C /*0x1E*/,
      0x50 /*0x1F*/, 0x00 /*0x20*/, 0x0C /*0x21*/,
      0x21 /*0x22*/, 0xF0 /*0x23*/, 0x40 /*0x24*/,
      0x00 /*0x25*/, 0x0A /*0x26*/, 0xF0 /*0x27*/,
      0x00 /*0x28*/, 0x00 /*0x29*/, 0x4E /*0x2A*/,
      0xF0 /*0x2B*/, 0x00 /*0x2C*/, 0x00 /*0x2D*/,
      0x4E /*0x2E*/, 0x88 /*!!R_CCAL!!*/, 0x88 /*!!R_CCAL2!!*/,
      0x84 /*!!R_CCAL3!!*/, 0x0B /*R_LEN*/, 0x29 /*R_LENH*/,
      0x03 /*0x34*/, 0x29 /*0x35*/, 0x00 /*0x36*/,
      0x00 /*0x37*/, 0x00 /*0x38*/, 0x00 /*0x39*/,
      0x00 /*0x3A*/, 0x00 /*0x3B*/, 0xFF /*0x3C*/,
      0x0F /*0x3D*/, 0x00 /*0x3E*/, 0x00 /*0x3F*/,
      0x01 /*0x40*/, 0x00 /*0x41*/, 0x80 /*R_CSTAT*/,
      0x03 /*R_SPD*/, 0x01 /*0x44*/, 0x00 /*0x45*/,
      0x39 /*!!R_CTL!!*/, 0xC0 /*0x47*/, 0x40 /*0x48*/,
      0x96 /*0x49*/, 0xD8 /*0x4A*/ };
    RegWriteArray(this,R_ALL, 74, uchRegs2651);
  }    /* #2651[066.7] */
  INST_ASSERT();
  RegWrite(this,0x34, 1, 0x03);    /* #2652[066.7] */
  RegWrite(this,0x49, 1, 0x96);    /* #2653[066.7] */
  RegWrite(this,R_CTL, 1, 0x79);    /* #2654[066.7] */
  RegWrite(this,R_CTL, 1, 0xF9);    /* #2655[066.7] */
  INST_ASSERT();
  WaitWhileScanning(this,3);
  cchBulk=2*RegRead(this, R_STAT, 2);
  INST_ASSERT();
  dprintf(DEBUG_SCAN,"reading %d bytes...\n",cchBulk);
  BulkRead(this,NULL,cchBulk); /* again, why 3840 ? */
  INST_ASSERT();
  return WaitWhileBusy(this,1);
}


